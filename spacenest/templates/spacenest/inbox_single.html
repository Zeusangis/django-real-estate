{% extends "main.html" %} {% block content %}
<!-- component -->
<main class="flex w-full h-full container mx-auto">
  <div class="hidden md:w-[700px] md:flex">
    {% include "spacenest/inbox_sidebar.html" %}
  </div>
  <section
    class="w-full px-2 pt-3 md:px-14 flex flex-col bg-white rounded-r-3xl"
  >
    <div class="flex justify-between items-center h-20 border-b-2 mb-8">
      <div class="flex space-x-4 items-center">
        <div class="h-12 w-12 rounded-full overflow-hidden">
          <img
            src="{{opposite_user.profile_image.url}}"
            loading="lazy"
            class="h-full w-full object-cover"
          />
        </div>
        <div class="flex flex-col">
          <h3 class="font-semibold text-lg">{{opposite_user.full_name}}</h3>
          <p class="text-light text-gray-400">{{opposite_user.email}}</p>
        </div>
      </div>
      <form class="" action="" method="post">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="delete_form" />
        <input type="hidden" name="id" value="{{mail.id}}" />
        <button type="submit">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-6 h-6 text-red-700"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
            />
          </svg>
        </button>
      </form>
    </div>
    <section
      id="messages-container"
      class="min-h-[490px] max-h-[490px] overflow-y-auto"
    >
      <article class="mt-8 text-gray-500 leading-7 tracking-wider">
        {% for message in mail %}
        <div
          class="flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %} mb-2"
        >
          <div
            class="rounded-lg p-2 {% if message.sender == request.user %}bg-indigo-500 text-white{% else %}bg-gray-200 text-gray-700{% endif %}"
          >
            <p>{{ message.message }}</p>
          </div>
        </div>
        {% endfor %}
      </article>
    </section>

    <form
      action="{% url 'inbox_single' mailbox.id %}"
      name="message"
      method="POST"
      class="border rounded-xl bg-gray-50 mb-3"
    >
      {% csrf_token %}
      <input type="hidden" name="form_name" value="reply_form" />
      <textarea
        name="message"
        class="w-full bg-gray-50 p-2 rounded-xl"
        placeholder="Type your reply here..."
        rows="2"
      ></textarea>
      <div class="flex items-center justify-between p-2">
        <button class="h-6 w-6 text-gray-400">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"
            />
          </svg>
        </button>
        <button
          class="bg-purple-600 text-white px-6 py-2 rounded-xl"
          type="submit"
        >
          Reply
        </button>
      </div>
    </form>
  </section>
</main>

<script>
  function fetchMessages() {
      const mailboxId = {% templatetag openvariable %} mailbox.id {% templatetag closevariable %};
      fetch(`/fetch-latest-messages/${mailboxId}/`)
          .then(response => response.json())
          .then(data => {
              const messagesContainer = document.getElementById("messages-container");
              messagesContainer.innerHTML = "";  // Clear existing messages

              data.messages.forEach(msg => {
                  const messageElement = document.createElement("div");
                  messageElement.classList.add("message", "p-2", "rounded-lg", "mb-2");

                  // Customize based on sender
                  if (msg.sender === "{% templatetag openvariable %} request.user.username {% templatetag closevariable %}") {
                      messageElement.classList.add("bg-indigo-500", "text-white", "text-right");
                  } else {
                      messageElement.classList.add("bg-gray-200", "text-gray-700");
                  }

                  messageElement.textContent = msg.message;
                  messagesContainer.appendChild(messageElement);
              });

              // Scroll to the bottom of the container
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
          })
          .catch(error => console.error("Error fetching messages:", error));
          console.log("Fetching messages...");
  }

  // Fetch new messages every 5 seconds
  setInterval(fetchMessages, 5000);  // Fetch new messages every 5 seconds
</script>

{% endblock %}
